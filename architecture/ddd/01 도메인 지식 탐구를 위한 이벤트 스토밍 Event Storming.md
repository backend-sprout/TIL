# 도메인 지식 탐구를 위한 이벤트 스토밍 Event Storming

# Domain Driven Design
* 실제 코드로 구현 가능한 현실성 있는 도메인 모델 분석과 그것을 추상화하는 설계
* 도메인 모델의 적용 범위를 구현까지 확장하여 도메인 지식을 구현 코드에 반영한다.

```
소프트웨어 본질은 해당 소프트웨어의 사용자를 위해 도메인에 관련된 문제를 해결하는 능력에 있다.
```

도메인이란, 소프트웨어로 해결하고자 하는 문제 영역

**많은 사람들이 묻는 질문**   
* 바운디드 컨텍스트를 나누는 기준은 무엇일까요?
* 애그리게잇은 어떻게 도출할 수 있나요?
* 현재 업무에 DDD를 도입하려면 어떻게 시작해야하나요?

위와 같은 의문들로 쉽사리 도입하기 어려운 영역이다.  

**DDD가 성공하기 위한 전제 조건**
* DDD는 개발자만을 위한 것이 아니다.   
* 이해 관계자(stakeholder)의 스폰서쉽이 적극적으로 필요하다.
	* 기획자
	* 개발자
	* 도메인 이해자 등등 

**DDD 도입이 어려운 이유**
* 사일로 내부에서만 전문가인 도메인 전문가(조직끼리 담 쌓음)
* 도메인에 거의 또는 전혀 관심이 없는 동료 개발자
* 모든 사람이 동일한 개념에 대해 다른 용어를 사용하거나, 다른 개념에 대해 동일한 용어를 사용한다.
* 하나의 기능을 개발하기 위해 동료A 에게도 물어보고 동료 B에게도 물어봐야 한다. 
	* 도메인 지식이 고르지 않게 분배되어, 
	  여러 도메인 지식이 필요한 복잡한 문제를 해결하기 위해 
	  필요한 지식을 수집하는 것이 쉽지가 않다.(커뮤니케이션에 대한 리소스가 많음)

# Event Storming
* 알베르토 브란돌리니가 제안한 복잡한 비즈니스 도메인을 빠르게 탐색하고 학습할 수 있는 워크숍
* **도메인 전문가와 개발자를 학습과정에 참여시키기 위한 빠른 설계**
* 코드를 없애고 모든 사람을 동일한 수준으로 만드는 시각적 접근 방법 

**준비물**
* 큰 회의실, 커다란 종이, 수많은 포스트잇과 마커팬
* 실제 문제 해결에 관련된 모든 사람(질문이 있는 사람, 답을 가진 사람)
* 퍼실리테이터(회의나 교육 따위의 진행이 원할하게 이루어지게 돕는 역할)

**진행 방법**
* 벽에 커다란 종이를 붙여놓고 그 위에 포스티잇을 붙여나간다.  
* 진행중 모든 사람의 생각을 허용하고 존중한다.
* 이벤트 스토밍의 가치는 포스트잇을 붙이는것이 아닌 커뮤니케이션이다.
* 비즈니스 프로세스를 이해하는데에 초점을 맞춘다.  
* 약 2시간 정도 진행한다.

**왜 포스트잇인가?**
* 가능한 가장 간단한 표기법을 사용하면 회의실에 있는 모든 사람이 적극적으로 참여할 수 있다.
* 떼어 내고 붙이기가 쉽기 때문에 이동이 가능하며, 틀린 경우에도 뗄 수 있어 부담을 줄일 수 있다. 
* 구현 코드보다 포스트잇을 변경하는 것이 훨씬 저렴하다. 

```
개발자가 아닌 사람에게 UML 다이어그램을 배우도록 강요해서는 안된다.   
이벤트 스토밍의 핵심 원칙은 참가자의 참여를 극대화 하는 것이다.  
```

## 1단계 : 혼란스러운 탐험
* 각자 알고 있는 **도메인 이벤트**를 작성하도록 요청한다.
* 각자가 작성한 이벤트는 볼 수 있지만, 토론을 시작하지 말고 자신일 옭다고 생각하는 방식으로 기록한다.

![[Pasted image 20221002205902.png]]

* **어떤 기능이 수행되었다.** 와 같은 기능/행위 중심의 이벤트를 먼저 도출하는 것도 나쁘지 않다. 
* 2시간의 워크숍에서 100개 ~ 200개 정도의 이벤트가 나와야한다. 

**도메인 이벤트 - 주황색**
* 도메인 전문가가 관심이 있는 어떤 사건
* 이벤트 이름은 과거에 일어났던 일을 표현하기 때문에 과거 시제를 사용한다.
* 이벤트가 발생했다는 것은 상태가 변경되었다는 것을 의미한다.

보통 `~할 때`, `~가 발생하면`, `만약 ~하면` 과 같은 요구사항을 정의한다. 

## 2단계 : 타임라인 적용
![[Pasted image 20221002210443.png]]
* 모든 도메인 이벤트를 올바른 타임라인으로 정렬하고 실제로 중복되는 이벤트를 제거한다.
	* 용어는 같지만 다른 개념일 수도 있다.(예시: '관리자'가 개발자인지 CS 인지 다를 수 있음)
* 시간은 왼쪽에서 오른쪽으로 흐르고, 위에서 아래로 평행한 시간을 표현할 수 있다.


![[Pasted image 20221002210431.png]]
**핫스폿 - 자주색**
* 2단계에서 발생한 갈등을 시각화하고 캡처하는데 사용한다.
* 당장 토론하지 않는다. 나중에 문제가 해결되면 제거한다.

![[Pasted image 20221002210609.png]]
**액터와 시스템 - 노란색과 분홍색**
* 단순한 '사용자' 또는 '고객'보다 구체적인 페르소나를 설정한다.
* 외부 시스템부터 일부 레거시 및 마이크로서비스에 이르기까지 책임을 전가할 수 있는 모든 것 

**바운디드 컨텍스트**
* 같은 용어라도 의미가 다르고 같은 대상이라도 지칭하는 용어가 다를 수 있다.
	* 이탈리아에서 커피는 에스프레소를 의미한다.
	* 미국에서 커피는 에스프레소에 물을 섞은 아메리카노를 뜻한다.  
* 명백한 언어 불일치는 종종 동일한 프로세스 내에서 여러 개의 **바운디드 컨텍스트**를 나타내는 지표다.  
* 바운디드 컨텍스트내에서 정의되는 언어를 유비쿼터스 언어라고 말한다.
	* 똑같은 '강의'라고 해도 어떤 컨텍스트에 있냐에 따라 컨텐츠/미션/상품을 의미할 수 있다.  
* 팀에서 역할이 무엇이든, 프로젝트에 참여하는 사람들이 유비 쿼터스 언어를 사용하도록 묶을 수 있는 장치는
  용어 사전이며, 유비 쿼터스 언어가 가장 지속적으로 유지되고 유일하게 보장되는 곳은 개발자의 코드지만
  유비쿼터스 언어는 개발자만의 것이 아님을 명심해야한다.  

![[Pasted image 20221002211357.png]]
**커맨드 또는 액션 - 파란색**
* 시스템에서 일어나는 일(실제 프로세스가 어떻게 이루어지는지 찾아봐야할 때)
* 커맨드는 **도메인 이벤트**가 발생하는 원인이 된다.

![[Pasted image 20221002211451.png]]
**리드 모델 또는 정보 - 초록색**
* 액터가 커맨드하는데 도움이 되는 정보
* 즉, 결정을 내리는데 필요한 정보
	* 강의 이름
	* 기간
	* 수강료
	* 모집 상태 등

![[Pasted image 20221002211533.png]]

**정책 - 연보라색**
* 주로 `~ 할 때마다` 라는 단어로 시작한다.
* **도메인 이벤트(주황)** 와 **커멘드(파랑)** 사이에 위치한다.
	* 단순한 조건부터 복잡한 정책까지 모두 가능하다.
	* 수강생이 등록될 때마다 
	  수강생 등록 정책은 
	  수강신청 성공 메일을 발송한다.

![[Pasted image 20221002211750.png]]	

* 위와 같은 절차로 인해 3단계 컨텍스트가 도출되었다.
* 정답은 없으며 각자의 상황에 맞게 포스트잇을 붙여나가면 된다.  

강사가 강의를 생성하고, 강의가 생성되었을때, 
강의가 정책에 의해서 미션 기반의 강의는 미션을 생성하고
유료 강의는 상품을 생성하게 된다.  

교육생은 강의 이름, 기간, 수강료, 모집상태를 보고 수강신청을 결정하게되며
수강 신청을 하였을때 결제 시도가 생성된다. 
이때 만들어진 결제 시도 ID로 페이팔에 결제 시도를 하게되며
그 결과에 따라 결제시도 성공과 결제시도 실패로 나뉘게 된다. 

결제시도가 실패했을 때는 그 이유를 교육생이 볼 수 있으며
결제시도가 성공했을 때는 결제시도 성공 정책에 의해서 결제가 생성된다. 
결제가 생성되면 수강생 등록으로 이어지며

수강생 등록 되었을 때 수강생 등록 정책에 의해 수강신청 성공 메일이 보내진다. 
강의 정원이 다차셔 수강생 등록애 실패되면 수강생 등록 실패 정책에 의해 페이팔에 결제 취소를 요청하며
페이팔에 결제취소가 되었을 때, 시스템에도 결제 취소를 기록하고 결제 취소 사유를 수강생에게 알려준다. 

![[Pasted image 20221002212833.png]]
**애그리게잇 또는 비즈니스 규칙 - 연노란색**
* 내부 시스템이 기대하는 책임을 수행하며 트랜잭션 일관성을 유지하는 단위
	* 장바구니의 합계는 항상 각 상품 수량의 해당 단가를 곱한 값이어야한다. 
	* 상품을 추가하거나 제거하더라도 불변식이 깨지면 안 된다.  
* 애그리게잇은 실제 주어진 클래스들의 계약을 정의하는 방범이며 내부 구현은 자유롭게 할 수 있다.
	* 일종의 캡슐
* 개발자가 아닌 사람에게 애그리게잇이란 용어를 강요해서는 안되며 비즈니스 규칙이라 바꿀 수 있다.
* 일관성은 항상 참이어야하는 속성을 유지함으로써 달성된다. 



![[Pasted image 20221002213059.png]]

* 수강 신청과 결제 컨텍스트는 `강의`, `결제 시도`, `결제` 3가지 에그리게잇으로 이루어진 것을 볼 수 있다.  
* 강의
	* 강의를 듣는 수강생의 수는 항상 정원을 넘을 수 없다.
* 결제 시도
	* 한번의 결제시도는 `결제 시도중` , `결제 성공`, `결제 실패` 중 하나의 상태만 가지고 있어야한다.
* 결제
	* 환불 금액은 전체 결제 금액보다 클 수 없다.

![[Pasted image 20221002213512.png]]
* 이벤트 스토밍이 익숙하지 않는 처음에는 색상 규칙을 고수하는 것이 좋다.
* 예시
	* 커멘드(파랑색)와 도메인 이벤트(주황색) 사이에 시스템(분홍색)이 있어야한다.
	* 커멘드(파랑색)와 도메인 이벤트(주황색) 사이에 정책(연보라색의)이 있어야한다.
  초보자도 누락된 도메인 지식을 빠르게 파악할 수 있게 된다. 

![[Pasted image 20221002213741.png]]
* 오프라인을 권장하나 코로나 이후 조금 달라짐

**우리가 얻을 수 있는 것**
* 모두가 서로에게서 배운다.
* 모두가 서로 소통한다.
* 자신의 관점에서 문제를 발견하면 누구나 말할 수 있다.
* 모두가 문제를 해결하는 방법에 대한 자신의 아이디어를 제공한다.
* 워크숍 후에는 모두가 같은 사실을 알게 된다.

